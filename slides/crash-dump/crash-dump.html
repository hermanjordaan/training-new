<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="author" content="Erlang Solutions Ltd."><title>Crash Dumps</title><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, minimal-ui" name="viewport"><link href="reveal.js/css/reveal.min.css" rel="stylesheet"><link rel="stylesheet" href="reveal.js/css/theme/default.css" id="theme"><link href="reveal.js/lib/css/zenburn.css" rel="stylesheet"><script type="text/javascript">document.write( '<link rel="stylesheet" href="reveal.js/css/print/' + ( window.location.search.match( /print-pdf/gi ) ? 'pdf' : 'paper' ) + '.css" type="text/css" media="print">' );</script></head><body><div class="reveal"><div class="slides"><section><h1>Crash Dumps</h1><p>Erlang Solutions Ltd.</p></section><div id="preamble"><div class="sectionbody"><link rel="stylesheet" type="text/css" href="../../styles/svg.css"></link>
<script type="text/javascript" src="../../tools/snap.svg/snap.svg-min.js"></script></div></div>
<section id="_erlang_crash_dumps"><h2>Erlang Crash Dumps</h2><div class="ulist"><ul><li><p>Crash Dumps</p></li><li><p>Example</p></li><li><p>Crash Slogans</p></li><li><p>Process Information</p></li><li><p>Other Information</p></li></ul></div></section>
<section id="_crash_dumps"><h2>Crash Dumps</h2><div class="ulist"><ul><li><p>The Erlang Virtual Machine (ERTS) crashes.</p></li><li><p>Event reports give no clues as to what caused the crash.</p></li><li><p>A watchdog monitors the system through heartbeats.</p><div class="ulist"><ul><li><p>The system has been automatically restarted.</p></li><li><p>Internal states are erased or changed.</p></li></ul></div></li><li><p>The crash can not be regenerated.</p></li><li><p><strong>What do we do?</strong></p></li></ul></div></section>
<section id="_crash_dumps_2"><h2>Crash Dumps</h2><div class="ulist"><ul><li><p><strong>Solution</strong>: use Erlang Crash Dumps</p></li><li><p>When the ERTS exits abnormally, a crash dump is created.</p></li><li><p>Crashes are due to errors the ERTS can not recover from:</p><div class="ulist"><ul><li><p>System limitations, bug in the ERTS or in the Erlang code, an Erlang process calling <strong>erlang:halt(Status).</strong></p></li></ul></div></li><li><p>Understanding the crash dump allows us to</p><div class="ulist"><ul><li><p>Reconfigure the system to avoid the limitations.</p></li><li><p>Efficiently detect software errors and fix them.</p></li></ul></div></li></ul></div></section>
<section id="_crash_dumps_3"><h2>Crash Dumps</h2><div class="ulist"><ul><li><p>Crash dumps will contain</p><div class="ulist"><ul><li><p>The time and reason for the crash</p></li><li><p>ERTS version number and compile date</p></li><li><p>Information on all processes</p></li><li><p>Internal table information</p></li><li><p>ETS table information</p></li><li><p>Timer information</p></li><li><p>Loaded module information</p></li><li><p>List of all atoms</p></li></ul></div></li><li><p>Crash dump formats can vary greatly  between releases.</p></li></ul></div></section>
<section id="_example"><h2>Example</h2><div class="literalblock"><div class="content"><pre>-module(atom_leak).
-export([start/0]).

start() -&gt;
    loop(0).

loop(N) -&gt;
    _ = list_to_atom(integer_to_list(N)),
    loop(N+1).
 </pre></div></div>
<div class="ulist"><ul><li><p>The code will dynamically generate atoms until no more space is left in the VM&#8217;s atom table.</p></li></ul></div></section>
<section id="_example_2"><h2>Example</h2><div class="pre"><b>$ erl +t 12000</b><span class="comment" style="color:#797979;">
Erlang R14B03 (erts-5.8.4) [source] [64-bit] [smp:4:4] [rq:4] [async-threads:0] [hipe] [kernel-poll:false]

Eshell V5.8.4  (abort with ^G)</span>
<b>1> atom_leak:start().</b>

Crash dump was written to: erl_crash.dump
no more index entries in atom_tab (max=12000)
Abort trap




</div></section>
<section id="_crash_slogans"><h2>Crash Slogans</h2><div class="ulist"><ul><li><p>The reason for the emulator crash is called the Slogan.</p><div class="ulist"><ul><li><p>It is a description generated by the kernel.</p></li><li><p>The string passed to the halt/1 BIF.</p></li></ul></div></li><li><p>The Slogan varies depending on</p><div class="ulist"><ul><li><p>The operating system</p></li><li><p>ERTS/OTP releases</p></li><li><p>Underlying applications</p></li></ul></div></li><li><p>The documented Slogans are are only suggestions.</p></li></ul></div></section>
<section id="_crash_slogans_2"><h2>Crash Slogans</h2><div class="paragraph"><p><strong>Can&#8217;t reallocate X bytes of memory</strong></p></div>
<div class="paragraph"><p><strong>Can&#8217;t allocate X bytes of memory</strong></p></div>
<div class="dlist"><dl><dt class="hdlist1"><strong>Can&#8217;t allocate X</strong></dt><dd><div class="ulist"><ul><li><p>The system has run out of memory</p></li><li><p>The amount of memory needed might give hints</p><div class="ulist"><ul><li><p>Large memory amounts might mean bugs in the Erlang code</p></li><li><p>Small amounts might mean fragmentation or ERTS bugs</p></li></ul></div></li><li><p>Process and ETS table sizes also give hints on the source of the problem</p></li></ul></div></dd></dl></div></section>
<section id="_crash_slogans_3"><h2>Crash Slogans</h2><div class="dlist"><dl><dt class="hdlist1"><strong>Got unstable memory block address, size X</strong></dt><dd><div class="ulist"><ul><li><p>The ERTS has reached its virtual memory space limit</p><div class="ulist"><ul><li><p>Something, possibly an Erlang process, consumes lots of memory</p></li></ul></div></li></ul></div></dd><dt class="hdlist1"><strong>Unexpected op code X</strong></dt><dd><div class="ulist"><ul><li><p>There is an error in the compiled code</p><div class="ulist"><ul><li><p>The beam file is corrupt</p></li><li><p>There is a bug in the compiler</p></li><li><p>The file was compiled for a different ERTS version</p></li></ul></div></li></ul></div></dd></dl></div></section>
<section id="_crash_slogans_4"><h2>Crash Slogans</h2><div class="dlist"><dl><dt class="hdlist1"><strong>Driver select with too large file descriptor</strong></dt><dd><div class="ulist"><ul><li><p>The ERTS tried to open too many sockets/pipes</p><div class="ulist"><ul><li><p>Not possible due to limitations in unix select calls</p></li></ul></div></li><li><p>The file descriptor limits can be changed</p><div class="ulist"><ul><li><p>Not the number of simultaneously open connections</p></li></ul></div></li><li><p>Open files are not affected</p></li></ul></div></dd><dt class="hdlist1"><strong>No function Module:Function/2 or Module:start/1</strong></dt><dd><div class="ulist"><ul><li><p>The system is not starting correctly</p><div class="ulist"><ul><li><p>The kernel/stdlib files are damaged</p></li><li><p>There are files missing or not in the code search path</p></li></ul></div></li></ul></div></dd></dl></div></section>
<section id="_crash_slogans_5"><h2>Crash Slogans</h2><div class="dlist"><dl><dt class="hdlist1"><strong>Init terminating in do_boot()</strong></dt><dd><div class="ulist"><ul><li><p>OTP Specific, there are errors in the boot script of a release</p><div class="ulist"><ul><li><p>The boot file can not be read or is the wrong one</p></li><li><p>Bad configuration parameters</p></li><li><p>Wrong ERTS/OTP version</p></li></ul></div></li></ul></div></dd></dl></div></section>
<section id="_crash_slogans_6"><h2>Crash Slogans</h2><div class="dlist"><dl><dt class="hdlist1"><strong>Could not start kernel pid (Who)</strong></dt><dd><div class="ulist"><ul><li><p>One of the kernel processes could not start</p><div class="ulist"><ul><li><p>Faulty configuration data or damaged configuration file</p></li><li><p>Configuration files in the wrong location</p></li></ul></div></li></ul></div></dd><dt class="hdlist1"><strong>Kernel pid terminated</strong></dt><dd><div class="ulist"><ul><li><p>Most often, the application controller has shut down</p></li><li><p>The top supervisor has terminated abnormally</p></li><li><p>The distributed node name is already being used.</p></li></ul></div></dd></dl></div></section>
<section id="_process_information"><h2>Process Information</h2><div class="ulist"><ul><li><p>Information on all processes is in the dump</p><div class="ulist"><ul><li><p>Process identifier and registered name</p></li><li><p>Process state</p></li><li><p>scheduled, waiting, running, exiting, suspended</p></li><li><p>The spawned function, module and arity</p></li><li><p>Size of the fragmented heap</p></li><li><p>Linked process list/ports and Process dictionary</p></li><li><p>Reductions, Stack + Heap size, Old Heap</p></li><li><p>Stack dump</p></li><li><p>Including variable values</p></li><li><p>Other information useful to the ERTS designers</p></li></ul></div></li></ul></div>
<aside class="notes"><div class="paragraph"><p>In some versions, the fragmented heap is incorrectly called the message buffer</p></div></aside></section>
<section id="_process_information_strong_r14b03_version_strong"><h2>Process Information: <strong>R14B03 version</strong></h2><div class="literalblock"><div class="content"><pre>=proc:&lt;0.31.0&gt;
State: Running
Spawned as: erlang:apply/2
Last scheduled in for: atom_leak:loop/1
Spawned by: &lt;0.25.0&gt;
Started: Wed Sep  7 08:35:36 2011
...
Link list: [&lt;0.25.0&gt;]
Reductions: 17619
Stack+heap: 987
OldHeap: 987
Heap unused: 355
OldHeap unused: 355
Program counter: 0x0000000011e46370 (atom_leak:loop/1 + 8)</pre></div></div>
<aside class="notes"><div class="paragraph"><p>Explain that past the 'Program Counter' field, you have the stack data (with more available when analysing non-tail-recursive calls) and that before that, you have the heap data available</p></div></aside></section>
<section id="_other_information"><h2>Other Information</h2><div class="ulist"><ul><li><p>Internal Table Information</p><div class="ulist"><ul><li><p>Useful to ERTS developers</p></li><li><p>Info on the module / atom tables / allocated binaries</p></li></ul></div></li><li><p>ETS Table Information</p><div class="ulist"><ul><li><p>Table name, number and owner</p></li><li><p>Number of elements and table size</p></li></ul></div></li><li><p>Timers</p></li><li><p>Loaded Module Information</p></li><li><p>All atoms</p></li></ul></div>
<aside class="notes"><div class="paragraph"><p>Explain that you can find the info by looking for lines beginning in <em>=</em> in the dump</p></div></aside></section>
<section id="_other_information_2"><h2>Other Information</h2><div class="ulist"><ul><li><p>Erlang crash dumps can be huge.</p></li><li><p>The crash dump file is stored:</p><div class="ulist"><ul><li><p>In the directory the emulator is running.</p></li><li><p>Where the environment variable <strong>ERL_CRASH_DUMP</strong> points to.</p></li><li><p>Assumes a writeable file system.</p></li></ul></div></li><li><p>If used correctly, useful to quickly locate errors.</p><div class="ulist"><ul><li><p>Even after the system restarted.</p></li><li><p>The Slogan is usually enough to understand the problem.</p></li></ul></div></li></ul></div>
<aside class="notes"><div class="paragraph"><p>If relevant to the group, add that crash dumps can be a useful resource to locate bugs in the ERTS, or disprove that there are none when you have no memory protection</p></div></aside></section>
<section id="_erlang_crash_dumps_2"><h2>Erlang Crash Dumps</h2><div class="ulist"><ul><li><p>Crash Dumps</p></li><li><p>Example</p></li><li><p>Crash Slogans</p></li><li><p>Process Information</p></li><li><p>Other Information</p></li></ul></div></section></div></div><script src="reveal.js/lib/js/head.min.js"></script><script src="reveal.js/js/reveal.min.js"></script><script type="text/javascript">// See https://github.com/hakimel/reveal.js#configuration for a full list of configuration options
Reveal.initialize({
  // Display controls in the bottom right corner
  controls: true,
  // Display a presentation progress bar
  progress: true,
  // Display the page number of the current slide
  slideNumber: true,
  // Push each slide change to the browser history
  history: true,
  // Enable keyboard shortcuts for navigation
  keyboard: true,
  // Enable the slide overview mode
  overview: true,
  // Vertical centering of slides
  center: false,
  // Enables touch navigation on devices with touch input
  touch: true,
  // Loop the presentation
  loop: false,
  // Change the presentation direction to be RTL
  rtl: false,
  // Turns fragments on and off globally
  fragments: true,
  // Flags if the presentation is running in an embedded mode,
  // i.e. contained within a limited portion of the screen
  embedded: false,
  // Number of milliseconds between automatically proceeding to the
  // next slide, disabled when set to 0, this value can be overwritten
  // by using a data-autoslide attribute on your slides
  autoSlide: 0,
  // Stop auto-sliding after user input
  autoSlideStoppable: true,
  // Enable slide navigation via mouse wheel
  mouseWheel: false,
  // Hides the address bar on mobile devices
  hideAddressBar: true,
  // Opens links in an iframe preview overlay
  previewLinks: false,
  // Theme (e.g., beige, blond, default, moon, night, serif, simple, sky, solarized)
  theme: Reveal.getQueryHash().theme || 'esl',
  // Transition style (e.g., default, cube, page, concave, zoom, linear, fade, none)
  transition: Reveal.getQueryHash().transition || 'linear',
  // Transition speed (e.g., default, fast, slow)
  transitionSpeed: 'default',
  // Transition style for full page slide backgrounds (e.g., default, none, slide, concave, convex, zoom)
  backgroundTransition: 'default',
  // Number of slides away from the current that are visible
  viewDistance: 3,
  // Parallax background image (e.g., "'https://s3.amazonaws.com/hakim-static/reveal-js/reveal-parallax-1.jpg'")
  parallaxBackgroundImage: '',
  // Parallax background size in CSS syntax (e.g., "2100px 900px")
  parallaxBackgroundSize: '',
  // Optional libraries used to extend on reveal.js
  dependencies: [
      { src: 'reveal.js/lib/js/classList.js', condition: function() { return !document.body.classList; } },
      { src: 'reveal.js/plugin/markdown/marked.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
      { src: 'reveal.js/plugin/markdown/markdown.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
      
      { src: 'reveal.js/plugin/zoom-js/zoom.js', async: true, condition: function() { return !!document.body.classList; } },
      { src: 'reveal.js/plugin/notes/notes.js', async: true, condition: function() { return !!document.body.classList; } }
  ]
});</script></body></html>