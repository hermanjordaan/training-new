<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="author" content="Erlang Solutions Ltd."><title>Behaviours and Servers</title><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, minimal-ui" name="viewport"><link href="reveal.js/css/reveal.min.css" rel="stylesheet"><link rel="stylesheet" href="reveal.js/css/theme/default.css" id="theme"><link href="reveal.js/lib/css/zenburn.css" rel="stylesheet"><script type="text/javascript">document.write( '<link rel="stylesheet" href="reveal.js/css/print/' + ( window.location.search.match( /print-pdf/gi ) ? 'pdf' : 'paper' ) + '.css" type="text/css" media="print">' );</script></head><body><div class="reveal"><div class="slides"><section><h1>Behaviours and Servers</h1><p>Erlang Solutions Ltd.</p></section><div id="preamble"><div class="sectionbody"><link rel="stylesheet" type="text/css" href="../../styles/svg.css"></link>
<script type="text/javascript" src="../../tools/snap.svg/snap.svg-min.js"></script></div></div>
<section id="_behaviours"><h2>Behaviours</h2><div class="ulist"><ul><li><p>Design Patterns</p></li><li><p>Behaviours</p></li><li><p>Examples</p></li></ul></div></section>
<section id="_design_patterns"><h2>Design Patterns</h2><div class="ulist"><ul><li><p>OTP Behaviours are a formalisation of design patterns</p></li><li><p>Processes share similar structures and life cycles</p><div class="ulist"><ul><li><p>They are started</p></li><li><p>They receive messages and send replies</p></li><li><p>They are terminated (or crash)</p></li></ul></div></li><li><p>Even if they perform different tasks, they will perform them following a set of patterns</p></li><li><p>Each design pattern solves a specific problem</p></li></ul></div>
<aside class="notes"><div class="paragraph"><p>Erlang doesn&#8217;t have strict design patterns, but they&#8217;re similar and have instead been implemented directly in the language. They are, according to <em>design pattern</em> speech, implementation libraries of design patterns</p></div>
<div class="paragraph"><p>Stress <em>similar structures</em>, because that&#8217;s what the pattern is.</p></div></aside></section>
<section id="_more_on_processes_strong_process_skeleton_strong"><h2>More on Processes: <strong>process skeleton</strong></h2><svg id="process_skeleton_1" style="width:1020px; height:620px;" viewBox="0 0 1020 620" preserveAspectRatio="xMinYMin meet">
<style type="text/css">
    #process_skeleton_1 .text {fill:#fff; font-size:20pt;}
    #process_skeleton_1 .grey {fill:#959595;}
    #process_skeleton_1 .code {font-size: 20pt;}
</style>
<script>

var s1 = Snap("#process_skeleton_1");

var arrow = s1.polygon([0,0, 4,2, 0,4]).attr({"fill":"#000"}).transform('r0').addClass("darkred");
var marker = arrow.marker(0,0, 4,4, 3,2);

s1.rect(10,35,965,580).addClass("rect_code");

s1.ellipse(900,50,80,35).addClass("shape darkred");
s1.text(870,60,"Start").addClass("text");

s1.rect(820,140,160,80).addClass("shape grey");
s1.text(845,190,"Initialise").addClass("text");

s1.ellipse(650,280,80,35).addClass("shape darkred");
s1.text(625,290,"Stop").addClass("text");

s1.rect(850,265,100,100,20,20).addClass("shape").attr({"fill":"#E1E1E1"});
s1.text(870,325,"loop");

s1.rect(820,410,160,80).addClass("shape grey");
s1.text(838,460,"terminate").addClass("text");

s1.path("M900,85 l0,57").attr({"marker-end":marker}).addClass("line_darkred");
s1.path("M900,220 l0,47").attr({"marker-end":marker}).addClass("line_darkred");
s1.path("M950,300 C1020,250 1020,380 953,330").attr({"marker-end":marker}).addClass("line_darkred");
s1.path("M730,280 l120,35").attr({"marker-end":marker}).addClass("line_darkred");
s1.path("M900,365 l0,47").attr({"marker-end":marker}).addClass("line_darkred");

s1.text(20,70,"start(Args) -> spawn(server, init, [Args])").addClass("code");
s1.text(20,108,"").addClass("code");
s1.text(20,146,"init(Args) ->").addClass("code");
s1.text(20,184,"  State = initialize_state(Args),").addClass("code");
s1.text(20,222,"  loop(State).").addClass("code");
s1.text(20,260,"").addClass("code");
s1.text(20,298,"loop(State) ->").addClass("code");
s1.text(20,336,"   receive").addClass("code");
s1.text(20,374,"      {handle, Msg} -> ").addClass("code");
s1.text(20,412,"         NewState = handle(Msg, State),").addClass("code");
s1.text(20,450,"         loop(NewState);").addClass("code");
s1.text(20,488,"      stop -> terminate(State)").addClass("code");
s1.text(20,526,"   end.").addClass("code");
s1.text(20,564,"").addClass("code");
s1.text(20,602,"terminate(State) -> clean_up(State).").addClass("code");

</script>
</svg>
<aside class="notes"><div class="paragraph"><p>The pattern behind all the patterns.
It&#8217;s so common even the functions get the same name in nearly any module.
Likely used even in code not written with OTP.</p></div>
<div class="paragraph"><p>In the terminate, you clean up resources: files, databases, etc. while init is the opposite.</p></div></aside></section>
<section id="_design_patterns_2"><h2>Design Patterns</h2><div class="centre">
<svg id="design_patterns_1" style="width:600; height:460px;" viewBox="0 0 600 460" preserveAspectRatio="xMinYMin meet">
<script>

var s2 = Snap("#design_patterns_1");

var arrow = s2.polygon([-2,0, -5,5, 5,0, -5,-5]).transform('r0');
var marker = arrow.marker(-6, -6, 12, 12).attr({"markerWidth":"6"});

s2.text(42,30,"Clients").addClass("code darkred bold");
s2.circle(100,110,40).addClass("shape grey");
s2.circle(100,250,40).addClass("shape grey");
s2.circle(100,390,40).addClass("shape grey");

s2.path("M200,25 l0,400").attr({"stroke-dasharray":"4,8"}).addClass("line");

s2.text(450,30,"Server").addClass("code darkred bold");
s2.circle(500,110,40).addClass("shape darkred");

s2_g1 = s2.g(s2.text(220,80,"request").addClass("code darkred"),
             s2.path("M155,90 l280,0").attr({"marker-end":marker}).addClass("line"))
            .addClass("hide")
s2_g2 = s2.g(s2.text(235,145,"reply").addClass("code darkred"),
             s2.path("M440,115 l-280,0").attr({"marker-end":marker}).addClass("line"))
            .addClass("hide")

s2_g3 = s2.g(s2.text(220,240,"request").addClass("code darkred").transform("rotate(-37,275,205)"),
             s2.path("M150,355 L440,140").attr({"marker-end":marker}).addClass("line"))
            .addClass("hide");
s2_g4 = s2.g(s2.text(270,305,"reply").addClass("code darkred").transform("rotate(-37,305,270)"),
             s2.path("M460,160 L160,385").attr({"marker-end":marker}).addClass("line"))
            .addClass("hide");

s2_anim1 = function() { s2_g1.animate({"opacity":"1"}, 500, mina.linear, s2_anim2); }
s2_anim2 = function() { s2_g2.animate({"opacity":"1"}, 500, mina.linear, s2_anim3); }
s2_anim3 = function() { s2_g3.animate({"opacity":"1"}, 500, mina.linear, s2_anim4); }
s2_anim4 = function() { s2_g4.animate({"opacity":"1"}, 500, mina.linear); }
s2.click(function() { s2_anim1() });

</script>
</svg>
</div>
<div class="ulist"><ul><li><p>Take a Client-Server architecture</p></li><li><p>What behaviours will differ between systems?</p></li><li><p>What similarities will there be between systems?</p></li></ul></div>
<aside class="notes"><div class="paragraph"><p>mention that this is erlang, the server is a process, the client is a process, communication is message passing</p></div></aside></section>
<section id="_design_patterns_3"><h2>Design Patterns</h2><div class="dlist left comparison green"><dl><dt class="hdlist1">Generic</dt><dd><div class="ulist"><ul><li><p>Spawning the server</p></li><li><p>Storing the loop data</p></li><li><p>Sending requests to the server</p></li><li><p>Sending replies to the client</p></li><li><p>Receiving server replies</p></li><li><p>Stopping the server</p></li></ul></div></dd></dl></div>
<div class="dlist right comparison darkred"><dl><dt class="hdlist1">Specific</dt><dd><div class="ulist"><ul><li><p>Initialising the server state</p></li><li><p>The loop data</p></li><li><p>The client requests</p></li><li><p>Handling client requests</p></li><li><p>Contents of server reply</p></li><li><p>Cleaning up</p></li></ul></div></dd></dl></div>
<aside class="notes"><div class="paragraph"><p>Go through every single one of these and compare them one to each other.</p></div></aside></section>
<section id="_behaviours_2"><h2>Behaviours</h2><div class="imageblock" style=""><div class="content"><img src="images/behaviours_1.png" alt="Behaviours" width="auto" height="275"></div></div>
<div class="paragraph"><p> <br></p></div>
<div class="ulist"><ul><li><p>The idea is to split the code in two parts</p></li><li><p>The generic part is called the <strong>generic behaviour</strong></p><div class="ulist"><ul><li><p>They are provided by OTP as library modules</p></li></ul></div></li><li><p>The specific part is called the <strong>callback module</strong></p><div class="ulist"><ul><li><p>They are implemented by the programmer</p></li></ul></div></li></ul></div>
<aside class="notes"><div class="paragraph"><p>Behaviours split generic and specific in two separate modules: one for generics and one for specifics. The generics are in the driving seat. The specifics know nothing of the generics.</p></div></aside></section>
<section id="_behaviours_3"><h2>Behaviours</h2><div class="dlist"><dl><dt class="hdlist1"><strong>Generic Servers</strong></dt><dd><p>Used to model client-server behaviours</p></dd><dt class="hdlist1"><strong>Generic Finite-State Machines</strong></dt><dd><p>Used for finite-state machine programming</p></dd><dt class="hdlist1"><strong>Generic Event Handler/Manager</strong></dt><dd><p>Used for writing event handlers</p></dd><dt class="hdlist1"><strong>Supervisors</strong></dt><dd><p>Used for fault-tolerant supervision trees</p></dd><dt class="hdlist1"><strong>Application</strong></dt><dd><p>Used to encapsulate resources and functionality</p></dd></dl></div></section>
<section id="_behaviours_4"><h2>Behaviours</h2><div class="dlist left comparison green"><dl><dt class="hdlist1">Pros</dt><dd><div class="ulist"><ul><li><p>Less code to develop</p></li><li><p>Less bugs</p></li><li><p>Solid well tested base</p></li><li><p>Free built-in functionality</p><div class="ulist"><ul><li><p>Log, Trace, Statistics, Extensible</p></li></ul></div></li><li><p>Common Programming Style</p></li><li><p>Component-based terminology</p></li></ul></div></dd></dl></div>
<div class="dlist right comparison darkred"><dl><dt class="hdlist1">Cons</dt><dd><div class="ulist"><ul><li><p>Steep learning curve</p></li><li><p>Affects performance</p></li></ul></div></dd></dl></div></section>
<section id="_a_server_example"><h2>A server Example</h2><div class="centre">
<svg id="server_example_1" style="width:720; height:460px;" viewBox="0 0 720 460" preserveAspectRatio="xMinYMin meet">
<script>

var s3 = Snap("#server_example_1");

var arrow = s3.polygon([-2,0, -5,5, 5,0, -5,-5]).transform('r0');
var marker = arrow.marker(-6, -6, 12, 12).attr({"markerWidth":"6"});

s3.text(42,30,"Clients").addClass("code darkred bold");
s3.image("images/phone1.png",60,50,210/2,229/2);
s3.image("images/phone2.png",50,200,201/2,201/2);
s3.image("images/phone3.png",40,315,240/2,246/2).transform("r-60");

s3.path("M200,45 l0,400").attr({"stroke-dasharray":"4,8"}).addClass("line");

s3.text(500,30,"Server").addClass("code darkred bold");
s3.circle(550,130,40).addClass("shape darkred");
s3.image("images/server.png",610,95,175/1.75,133/1.75);

s3_g1 = s3.g(s3.text(250,110,"allocate").addClass("code darkred"),
             s3.path("M155,120 l330,0").attr({"marker-end":marker}).addClass("line"))
            .addClass("hide");
s3_g2 = s3.g(s3.text(205,175,"{ok, Frequency}").addClass("code darkred"),
             s3.path("M490,145 l-330,0").attr({"marker-end":marker}).addClass("line"))
            .addClass("hide");

s3_g3 = s3.g(s3.text(110,268,"{deallocate, Freq}").addClass("code darkred").transform("rotate(-32,305,235)"),
             s3.path("M150,385 L490,170").attr({"marker-end":marker}).addClass("line"))
            .addClass("hide");
s3_g4 = s3.g(s3.text(310,350,"ok").addClass("code darkred").transform("rotate(-37,305,300)"),
             s3.path("M510,190 L170,405").attr({"marker-end":marker}).addClass("line"))
            .addClass("hide");

s3_anim1 = function() { s3_g1.animate({"opacity":"1"}, 500, mina.linear, s3_anim2); }
s3_anim2 = function() { s3_g2.animate({"opacity":"1"}, 500, mina.linear, s3_anim3); }
s3_anim3 = function() { s3_g3.animate({"opacity":"1"}, 500, mina.linear, s3_anim4); }
s3_anim4 = function() { s3_g4.animate({"opacity":"1"}, 500, mina.linear); }
s3.click(function() { s3_anim1() });

</script>
</svg>
</div>
<div class="ulist"><ul><li><p>The following server is responsible for allocating and deallocating frequencies on behalf of mobile phones</p></li></ul></div>
<aside class="notes"><div class="paragraph"><p>This is a <strong>simplified</strong> example</p></div></aside></section>
<section id="_finite_state_machines"><h2>Finite-State Machines</h2><svg id="finite_state_machines_1" style="width:1100px; height:470px;" viewBox="0 0 1100 470" preserveAspectRatio="xMinYMin meet">
<script>

var s4 = Snap("#finite_state_machines_1");

var arrow_red = s4.polygon([0,0, 4,2, 0,4]).attr({"fill":"#000"}).transform('r0 s1.25').addClass("darkred");
var marker_red = arrow_red.marker(0,0, 4,4, 3,2);

var arrow = s4.polygon([0,0, 4,2, 0,4]).attr({"fill":"#000"}).transform('r0 s1.25');
var marker = arrow.marker(0,0, 4,4, 3,2);

s4.text(240,80,"Day").addClass("darkred bold");
s4.circle(300,150,50).addClass("shape darkred")
s4.text(670,80,"Night").addClass("darkred bold");
s4.circle(700,150,50).addClass("shape grey")

s4_g1 = s4.g(s4.path("M350,110 Q500,40 650,110").addClass("line").attr({"marker-end":marker}),
             s4.text(500,110,"Sunset").addClass("middle")).addClass("hide");
s4_g2 = s4.g(s4.path("M650,190 Q500,260 350,190").addClass("line_darkred").attr({"marker-end":marker_red}),
             s4.text(500,210,"Sunrise").addClass("middle")).addClass("hide");

s4.text(150,280,"day() ->").addClass("code");
s4.text(150,320,"  receive").addClass("code");
s4.text(150,360,"     sunset -> night()").addClass("code");
s4.text(150,400,"  end.").addClass("code");

s4.text(630,280,"night() ->").addClass("code");
s4.text(630,320,"  receive").addClass("code");
s4.text(630,360,"     sunrise -> day()").addClass("code");
s4.text(630,400,"  end.").addClass("code");

s4_anim1 = function() { s4_g1.animate({"opacity":"1"}, 375, mina.linear); }
s4_anim2 = function() { s4_g2.animate({"opacity":"1"}, 375, mina.linear); }

var s4_counter=1
s4.click( function() {
  switch(s4_counter) {
    case 1: {s4_anim1(); s4_counter++; break};
    case 2: {s4_anim2(); s4_counter++; break};
    }
} );

</script>
</svg>
<div class="ulist"><ul><li><p>Each state is represented as a tail recursive function</p></li><li><p>Each event is represented as an incoming message</p></li></ul></div></section>
<section id="_fsm_example"><h2>FSM Example</h2><div class="imageblock" style=""><div class="content"><img src="images/fsm_example.png" alt="FSM Example" width="auto" height="auto"></div></div></section>
<section id="_behaviours_5"><h2>Behaviours</h2><div class="ulist"><ul><li><p>Design Patterns</p></li><li><p>Behaviours</p></li><li><p>Examples</p></li></ul></div></section>
<section id="_generic_servers"><h2>Generic Servers</h2><div class="ulist"><ul><li><p>Generic Servers</p></li><li><p>Starting a Server</p></li><li><p>Message Passing</p></li><li><p>Termination</p></li><li><p>Other Messages</p></li><li><p>Timeouts</p></li><li><p>Other Issues</p></li></ul></div></section>
<section id="_generic_servers_2"><h2>Generic Servers</h2><div class="imageblock" style=""><div class="content"><img src="images/generic_servers.png" alt="Generic Servers" width="auto" height="auto"></div></div>
<div class="paragraph"><p><br></p></div>
<div class="ulist"><ul><li><p>The <strong>gen_server</strong> module implements the client-server behaviour</p><div class="ulist"><ul><li><p>It is part of the standard library application</p></li></ul></div></li><li><p>The library module contains all the generic code</p></li><li><p>Non-generic code is placed in the callback module</p></li></ul></div>
<aside class="notes"><div class="paragraph"><p>reiterate the separations between generic and specific.</p></div></aside></section>
<section id="_generic_servers_3"><h2>Generic Servers</h2><div class="pre">-module(frequency).
<b>-behaviour(gen_server).</b>

-export([start_link/1, init/1, ...]).

start_link(...) -> ...
</div>
<div class="ulist"><ul><li><p>Call back modules must have two extra directives</p></li><li><p><strong>behaviour</strong> directive, used at compile time</p></li></ul></div>
<aside class="notes"><div class="paragraph"><p>you might mention that behaviours will warn you at compile-time if you&#8217;re missing any callback.</p></div></aside></section>
<section id="_starting_a_server"><h2>Starting a Server</h2><svg id="starting_a_server_1" style="width:1100px; height:320px;" viewBox="0 0 1100 320" preserveAspectRatio="xMinYMin meet">
<script>

var s5 = Snap("#starting_a_server_1");

var arrow = s5.polygon([-2,0, -5,5, 5,0, -5,-5]).transform('r0');
var marker = arrow.marker(-6, -6, 12, 12).attr({"markerWidth":"6"});

s5.text(130,150,"Supervisor");
s5.circle(350,150,40).addClass("shape").attr({"fill":"#A6A6A6"});
s5.circle(350,150,35).addClass("shape").attr({"fill":"#797979"});
s5_g2 = s5.g(s5.text(740,150,"Name/Pid"),
             s5.circle(680,150,40).addClass("shape darkred")).addClass("hide");
s5_g1 = s5.path("M405,150 l215,0").addClass("line").attr({"marker-end":marker, "strokeDasharray":"6,6"}).addClass("hide");

s5.text(100,40,"gen_server:start_link({local, Name}, Mod, Args, [])").addClass("code");
s5_g6 = s5.path("M785,75 l70,0").addClass("line").attr({"marker-end":marker}).addClass("hide");
s5_g7 = s5.text(880,85,"{ok, Pid}").addClass("code").addClass("hide");

s5_g3 = s5.text(380,260,"{Mod:init(Args)").addClass("code").addClass("hide");
s5_g4 = s5.path("M670,250 l60,0").addClass("line").attr({"marker-end":marker}).addClass("hide");
s5_g5 = s5.text(765,260,"{{ok, LoopData}").addClass("code").addClass("hide");

s5_anim1 = function() { s5_g1.animate({"opacity":"1"}, 375, mina.linear, s5_anim2); }
s5_anim2 = function() { s5_g2.animate({"opacity":"1"}, 375, mina.linear, s5_anim3); }
s5_anim3 = function() { s5_g3.animate({"opacity":"1"}, 375, mina.linear); }
s5_anim4 = function() { s5_g4.animate({"opacity":"1"}, 375, mina.linear, s5_anim5); }
s5_anim5 = function() { s5_g5.animate({"opacity":"1"}, 375, mina.linear); }
s5_anim6 = function() { s5_g6.animate({"opacity":"1"}, 375, mina.linear, s5_anim7); }
s5_anim7 = function() { s5_g7.animate({"opacity":"1"}, 375, mina.linear); }

var s5_counter=1
s5.click( function() {
  switch(s5_counter) {
    case 1: {s5_anim1(); s5_counter++; break};
    case 2: {s5_anim4(); s5_counter++; break};
    case 3: {s5_anim6(); s5_counter++; break};
    }
} );

</script>
</svg>
<div class="ulist"><ul><li><p><strong>gen_server:start_link/4</strong> creates a new server</p><div class="ulist"><ul><li><p>Name is the process name</p></li><li><p>Mod is the name of the callback module</p></li><li><p>Args are the arguments passed to the init function</p></li></ul></div></li><li><p><strong>init/1</strong> is called by the server callback module</p><div class="ulist"><ul><li><p>It initialises the process state and returns the loop data</p></li></ul></div></li></ul></div>
<aside class="notes"><div class="paragraph"><p>stress the order things are executed in, describe it.
- Synchronized startup is important in order to know when things go wrong.
  (It can be actually be fast compared to asynchronous startups given the need
   to check if everything went right if there are dependencies)</p></div></aside></section>
<section id="_message_passing_strong_synchronous_strong"><h2>Message Passing: <strong>synchronous</strong></h2><div style="text-align:center;">
<svg id="message_passing_synchronous_1" style="width:1000px; height:400px;" viewBox="0 0 1000 400" preserveAspectRatio="xMinYMin meet">
<script>

var s6 = Snap("#message_passing_synchronous_1");

var arrow = s6.polygon([-2,0, -5,5, 5,0, -5,-5]).transform('r0');
var marker = arrow.marker(-6, -6, 12, 12).attr({"markerWidth":"6"});

s6.text(40,40,"gen_server:call(Name, Message)").addClass("code");
s6_g6 = s6.path("M580,30,l100,0").addClass("line hide").attr({"marker-end":marker})
s6_g7 = s6.text(710,40,"Reply").addClass("code hide");

s6.circle(230,150,40).addClass("shape grey");
s6_g1 = s6.g(s6.text(370,115,"Message").addClass("code"),
             s6.path("M290,125,l260,0").addClass("line").attr({"marker-end":marker})).addClass("hide");
s6_g5 = s6.g(s6.text(388,165,"Reply").addClass("code"),
             s6.path("M555,175,l-260,0").addClass("line").attr({"marker-end":marker})).addClass("hide");
s6.circle(620,150,40).addClass("shape darkred");
s6.text(680,150,"Name");

s6_g2 = s6.text(300,250,"Mod:handle_call(Message,_From,LoopData)").addClass("code hide");
s6_g3 = s6.path("M640,270,l0,40").addClass("line hide").attr({"marker-end":marker});
s6_g4 = s6.text(400,350,"{reply, Reply, NewLoopData}").addClass("code hide");

s6_anim1 = function() { s6_g1.animate({"opacity":"1"}, 500, mina.linear, s6_anim2); }
s6_anim2 = function() { s6_g2.animate({"opacity":"1"}, 250, mina.linear); }
s6_anim3 = function() { s6_g3.animate({"opacity":"1"}, 250, mina.linear, s6_anim4); }
s6_anim4 = function() { s6_g4.animate({"opacity":"1"}, 250, mina.linear); }
s6_anim5 = function() { s6_g5.animate({"opacity":"1"}, 500, mina.linear, s6_anim6); }
s6_anim6 = function() { s6_g6.animate({"opacity":"1"}, 250, mina.linear, s6_anim7); }
s6_anim7 = function() { s6_g7.animate({"opacity":"1"}, 250, mina.linear); }

var s6_counter=1
s6.click( function() {
  switch(s6_counter) {
    case 1: { s6_anim1(); s6_counter++; break};
    case 2: { s6_anim3(); s6_counter++; break};
    case 3: { s6_anim5(); s6_counter++; break};
    }
} );

</script>
</svg>
</div>
<div class="ulist"><ul><li><p><strong>gen_server:call/2</strong> is used by the client to send requests</p><div class="ulist"><ul><li><p>Requests are synchronous</p></li><li><p>Handled in the <strong>handle_call/3</strong> function in the callback module</p></li></ul></div></li><li><p><strong>handle_call/3</strong> returns the tuple <strong>{reply, Reply, NewLoopData}</strong>.</p></li></ul></div>
<aside class="notes"><div class="paragraph"><p>don&#8217;t explain <em>From until the end, if someone asks a question. The students don&#8217;t need to worry about it for now.
Maybe introduce gen_server:reply if they ask the question
_</em></p></div></aside></section>
<section id="_message_passing_strong_asynchronous_strong"><h2>Message Passing: <strong>asynchronous</strong></h2><div style="text-align:center;">
<svg id="message_passing_asynchronous_1" style="width:1000px; height:400px;" viewBox="0 0 1000 400" preserveAspectRatio="xMinYMin meet">
<script>

var s7 = Snap("#message_passing_asynchronous_1");

var arrow = s7.polygon([-2,0, -5,5, 5,0, -5,-5]).transform('r0');
var marker = arrow.marker(-6, -6, 12, 12).attr({"markerWidth":"6"});

s7.text(40,40,"gen_server:cast(Name, Message)").addClass("code");
s7_g2 = s7.g(s7.path("M580,30,l100,0").addClass("line").attr({"marker-end":marker}),
             s7.text(710,40,"ok").addClass("code")).addClass("hide");

s7.circle(230,150,40).addClass("shape grey");
s7_g1 = s7.g(s7.text(370,125,"Message").addClass("code"),
             s7.path("M290,135,l260,0").addClass("line").attr({"marker-end":marker})).addClass("hide");

s7.circle(620,150,40).addClass("shape darkred");
s7.text(680,160,"Name");

s7_g3 = s7.text(300,250,"Mod:handle_cast(Message, LoopData)").addClass("code hide");

s7_g4 = s7.path("M640,270,l0,40").addClass("line hide").attr({"marker-end":marker});
s7_g5 = s7.text(400,350,"{noreply, NewLoopData}").addClass("code hide");

s7_anim1 = function() { s7_g1.animate({"opacity":"1"}, 500, mina.linear, s7_anim2); }
s7_anim2 = function() { s7_g2.animate({"opacity":"1"}, 250, mina.linear, s7_anim3); }
s7_anim3 = function() { s7_g3.animate({"opacity":"1"}, 250, mina.linear); }
s7_anim4 = function() { s7_g4.animate({"opacity":"1"}, 500, mina.linear, s7_anim5); }
s7_anim5 = function() { s7_g5.animate({"opacity":"1"}, 500, mina.linear); }

var s7_counter=1
s7.click( function() {
  switch(s7_counter) {
    case 1: { s7_anim1(); s7_counter++; break};
    case 2: { s7_anim4(); s7_counter++; break};
    }
} );

</script>
</svg>
</div>
<div class="ulist"><ul><li><p><strong>gen_server:cast/2</strong> is used by the client to send messages</p><div class="ulist"><ul><li><p>Requests are asynchronous</p></li><li><p>Handled in the <strong>handle_cast/2</strong> function in the callback module</p></li></ul></div></li><li><p><strong>handle_cast/2</strong> returns the tuple <strong>{noreply, NewLoopData}</strong>.</p></li></ul></div></section>
<section id="_termination"><h2>Termination</h2><div class="literalblock"><div class="content"><pre>Mod:init/1        -&gt; {stop, Reason}

Mod:handle_call/3 -&gt; {stop, Reason, Reply, NewLoopData}
Mod:handle_cast/2 -&gt; {stop, Reason, NewLoopData}

Mod:terminate(Reason, LoopData) -&gt; Term
 </pre></div></div>
<div class="ulist"><ul><li><p>Returning <strong>stop</strong> instead of <strong>reply</strong> / <strong>noreply</strong> stops the server</p></li><li><p>The call back function <strong>terminate/2</strong> is called</p><div class="ulist"><ul><li><p>It allows the server to clean up before terminating</p></li><li><p>Its return value is ignored</p></li></ul></div></li></ul></div>
<aside class="notes"><div class="paragraph"><p>Call back <strong>terminate/2</strong> NOT called after init!</p></div></aside></section>
<section id="_termination_2"><h2>Termination</h2><svg id="termination_1" style="width:1000px; height:600px;" viewBox="0 0 1000 600" preserveAspectRatio="xMinYMin meet">
<style type="text/css">#termination_1 .line2 {stroke: #4B5056;} .fill2 {fill: #4B5056;}</style>
<script>

var s8 = Snap("#termination_1");

var arrow = s8.polygon([-2,0, -5,5, 5,0, -5,-5]).transform('r0').addClass("darkred");
var marker = arrow.marker(-6, -6, 12, 12).attr({"markerWidth":"6"});

var arrow = s8.polygon([-2,0, -5,5, 5,0, -5,-5]).transform('r0').addClass("fill2");
var marker2 = arrow.marker(-6, -6, 12, 12).attr({"markerWidth":"6"});

s8.rect(10,50,965,540).addClass("rect_code");

s8.text(15,80,"stop() ->").addClass("code");
s8.text(15,125,"    gen_server:cast(frequency, stop).").addClass("code");
s8.text(15,170,"").addClass("code");
s8.text(15,215,"").addClass("code");
s8.text(15,260,"handle_cast(stop, Frequencies) ->").addClass("code");
s8.text(15,305,"    {stop, normal, Frequencies}.").addClass("code");
s8.text(15,350,"").addClass("code");
s8.text(15,395,"").addClass("code");
s8.text(15,440,"terminate(Reason, {Free, Allocated}) ->").addClass("code");
s8.text(15,485,"    % Clean up on termination").addClass("code");
s8.text(15,530,"    ok.").addClass("code");

s8_g1 = s8.g(s8.ellipse(590,115,45,30).addClass("line line2").attr({"stroke-dasharray":"8,6"}),
             s8.path("M550,130 305,230").addClass("line line2").attr({"marker-end":marker2,"stroke-dasharray":"8,6"}).addClass("")).addClass("hide");

s8_g2 = s8.ellipse(260,250,45,30).addClass("line line2").attr({"stroke-dasharray":"8,6"}).addClass("hide");

s8_g3 = s8.g(s8.ellipse(259,297,65,28).addClass("line_darkred").addClass(""),
             s8.path("M254,326 249,394").addClass("line_darkred").attr({"marker-end":marker}).addClass(""),
             s8.ellipse(440,297,110,30).addClass("line_darkred").addClass(""),
             s8.path("M445,327 455,393").addClass("line_darkred").attr({"marker-end":marker}).addClass("")).addClass("hide");

s8_g4 = s8.g(s8.ellipse(244,430,65,28).addClass("line_darkred").addClass(""),
             s8.ellipse(485,430,160,30).addClass("line_darkred").addClass("")).addClass("hide");

//diagram
s8.ellipse(920,65,60,30).addClass("shape darkred");
s8.text(892,74,"Start").addClass("white").attr({"font-size":"17pt"});
s8.path("M920,95 l0,35").addClass("line_darkred").attr({"marker-end":marker});
s8.rect(860,138,120,60).addClass("shape grey");
s8.text(873,177,"Initialise").addClass("white").attr({"font-size":"17pt"});
s8.path("M920,199 l0,28").addClass("line_darkred").attr({"marker-end":marker});
s8.rect(882.5,235,75,75,15).addClass("shape lightgrey");
s8.text(895,281,"loop").attr({"font-size":"17pt"});
s8.path("M958,260 C1003,225 1003,315 964 284").addClass("line_darkred").attr({"marker-end":marker});
s8.path("M920,310 l0,28").addClass("line_darkred").attr({"marker-end":marker});
s8.rect(860,345,120,60).addClass("shape grey");
s8.text(866.5,383,"terminate").addClass("white").attr({"font-size":"17pt"});
s8.ellipse(720,245,60,30).addClass("shape darkred");
s8.text(695,253,"Stop").addClass("white").attr({"font-size":"17pt"});
s8.path("M781,245 l93,25").addClass("line_darkred").attr({"marker-end":marker});

s8_anim1 = function() { s8_g1.animate({"opacity":"1"}, 500, mina.linear); }
s8_anim2 = function() { s8_g2.animate({"opacity":"1"}, 500, mina.linear); }
s8_anim3 = function() { s8_g3.animate({"opacity":"1"}, 500, mina.linear, s8_anim4); }
s8_anim4 = function() { s8_g4.animate({"opacity":"1"}, 500, mina.linear); }

var s8_counter=1
s8.click( function() {
  switch(s8_counter) {
    case 1: {s8_anim1(); s8_counter++; break};
    case 2: {s8_anim2(); s8_counter++; break};
    case 3: {s8_anim3(); s8_counter++; break};
    }
} );

</script>
</svg></section>
<section id="_termination_3"><h2>Termination</h2><svg id="termination_2" style="width:1000px; height:420px;" viewBox="0 0 1000 420" preserveAspectRatio="xMinYMin meet">
<style type="text/css">#termination_2 .line2 {stroke: #4B5056;} .fill2 {fill: #4B5056;}</style>
<script>

var s9 = Snap("#termination_2");

var arrow = s9.polygon([-2,0, -5,5, 5,0, -5,-5]).transform('r0');
var marker = arrow.marker(-6, -6, 12, 12).attr({"markerWidth":"6"});

s9_g1 = s9.polyline([160,200,196.3543676,225.3559301,152.0626766,227.0320409,168.9374661,268.0174617,130.7707507,245.4815998,122.8083354,289.0839298,102.8842581,249.4910721,72.61264883,281.8668796,77.2569633,237.7874787,34.28718205,248.6576736,62.02535132,214.0866278,20,200,62.02535132,185.9133722,34.28718205,151.3423264,77.2569633,162.2125213,72.61264883,118.1331204,102.8842581,150.5089279,122.8083354,110.9160702,130.7707507,154.5184002,168.9374661,131.9825383,152.0626766,172.9679591,196.3543676,174.6440699]).addClass("darkred shape hide").transform("t400 -80 r25");

s9.circle(510,120,40).addClass("shape grey");
s9_g2 = s9.path("M510,220 l0,80").addClass("line hide").attr({"marker-end":marker});
s9_g3 = s9.g(s9.text(140,350,"Mod:terminate(Reason, LoopData)").addClass("code"),
		s9.path("M700,340 l70,0").addClass("line").attr({"marker-end":marker}),
		s9.text(800,350,"Term").addClass("code")).addClass("hide");

s9_anim1 = function() { s9_g1.animate({"opacity":"1"}, 750, mina.linear, s9_anim2); }
s9_anim2 = function() { s9_g2.animate({"opacity":"1"}, 500, mina.linear, s9_anim3); }
s9_anim3 = function() { s9_g3.animate({"opacity":"1"}, 500, mina.linear); }
s9.click(function() { s9_anim1() });

</script>
</svg>
<div class="ulist"><ul><li><p>If the parent process crashes, <strong>terminate/2</strong> is called</p><div class="ulist"><ul><li><p>The server must be trapping exits: <strong>process_flag(trap_exit, true)</strong>.</p></li><li><p><strong>Reason</strong> will be the reason of termination</p></li></ul></div></li></ul></div>
<aside class="notes"><div class="paragraph"><p>The returned term is discarded.</p></div>
<div class="paragraph"><p>if you want to be sure terminate is called, the process should be trapping exits, otherwise a parent or linked process could bring it down and not allow for a proper termination.</p></div>
<div class="paragraph"><p>look at the context for the cleanup (<em>Reason</em>). If the reason is that the resource you had to clean up died, don&#8217;t try to clean it up!</p></div></aside></section>
<section id="_other_messages"><h2>Other Messages</h2><div class="pre" style="text-align:center;">monitor_node(Node, True)
Pid ! Message
process_flag(trap_exit, true), link(Pid)
<span style="font-size:2em;">&darr;</span>
Mod:handle_info(Message, LoopData)
<span style="font-size:2em;">&darr;</span>
{noreply, NewLoopData}
{stop, Reason, NewLoopData}
</div>
<div class="ulist"><ul><li><p>Generic servers follow a protocol hidden in the <strong>gen_server:cast/2</strong> and <strong>gen_server:call/2</strong> function calls</p></li><li><p>Messages not following this protocol must be handled</p></li><li><p>They are handled in the <strong>handle_info/2</strong> callback function</p></li></ul></div></section>
<section id="_timeouts"><h2>Timeouts</h2><svg id="timeouts_1" style="width:1000px; height:350px;" viewBox="0 0 1000 350" preserveAspectRatio="xMinYMin meet">
<script>

var s10 = Snap("#timeouts_1");

var arrow = s10.polygon([-2,0, -5,5, 5,0, -5,-5]).transform('r0');
var marker = arrow.marker(-6, -6, 12, 12).attr({"markerWidth":"6"});

var clock = s10.polygon([0,0, 3,1.5, 0,3]).attr({"fill":"#000"}).transform('r0');
var hand = clock.marker(0,0, 3,3, 2,1.5);

s10.text(200,50,"gen_server:call(Name, Message, Timeout)").addClass("code");

s10_g2 = s10.polyline([160,200,196.3543676,225.3559301,152.0626766,227.0320409,168.9374661,268.0174617,130.7707507,245.4815998,122.8083354,289.0839298,102.8842581,249.4910721,72.61264883,281.8668796,77.2569633,237.7874787,34.28718205,248.6576736,62.02535132,214.0866278,20,200,62.02535132,185.9133722,34.28718205,151.3423264,77.2569633,162.2125213,72.61264883,118.1331204,102.8842581,150.5089279,122.8083354,110.9160702,130.7707507,154.5184002,168.9374661,131.9825383,152.0626766,172.9679591,196.3543676,174.6440699]).addClass("darkred shape hide").transform("t120 0");

s10.circle(230,200,40).addClass("shape grey");

s10_clock = s10.g(s10.circle(100,100,48).attr({"fill":"none", "stroke":"#888", "stroke-width":"2"}),
			    s10.path("M100,100 l0,-40").attr({"stroke":"#000", "stroke-width":"2", "marker-end":hand}),
			    s10.path("M100,100 l24,-18").attr({"stroke":"#000", "stroke-width":"2", "marker-end":hand}))
			   .transform("t750,100");

s10.path("M770,200 l-420,0").addClass("line").attr({"marker-end":marker});

s10_g1 = s10.path("M340,200 l430,0").attr({"stroke-width":"14pt","stroke":"#fff","strokeDasharray":430});

s10.click(function() { s10_g1.animate({"strokeDashoffset":"430"}, 750, mina.linear); });

s10_anim1 = function() { s10_g1.animate({"strokeDashoffset":"430"}, 750, mina.linear, s10_anim2); }
s10_anim2 = function() { s10_g2.animate({"opacity":"1"}, 500, mina.linear); }

s10.click(function() { s10_anim1() });

</script>
</svg>
<div class="ulist"><ul><li><p>Timeouts can be set on client calls</p></li><li><p>Timeout is an integer in milliseconds or the atom <strong>infinity</strong></p></li><li><p>Default timeout is 5000ms</p></li><li><p>If the client does not receive a response, it terminates</p></li></ul></div></section>
<section id="_timeouts_2"><h2>Timeouts</h2><svg id="timeouts_2" style="width:1200px; height:300px;" viewBox="0 0 1100 300" preserveAspectRatio="xMinYMin meet">
<script>

var s11 = Snap("#timeouts_2");

var arrow = s11.polygon([-2,0, -4,4, 4,0, -4,-4]).transform('r0');
var marker = arrow.marker(-6, -6, 12, 12).attr({"markerWidth":"6"});

s11.rect(10,10,1090,280).addClass("rect_code");

s11.text(18,40, "Mod:init/1             {ok, LoopData, Timeout}").addClass("code");
s11.text(18,40, "                                      Timeout").addClass("code bold darkred");
s11.text(18,80, "Mod:handle_call/3      {reply, Reply, NewLoopData, Timeout}").addClass("code");
s11.text(18,80, "                                                   Timeout").addClass("code bold darkred");
s11.text(18,120,"Mod:handle_cast/2      {noreply, NewLoopData, Timeout}").addClass("code");
s11.text(18,120,"                                              Timeout").addClass("code bold darkred");
s11.text(18,160,"Mod:handle_info/2      {noreply, NewLoopData, Timeout}").addClass("code");
s11.text(18,160,"                                              Timeout").addClass("code bold darkred");
s11.text(18,260,"                       Mod:handle_info(timeout, LoopData)").addClass("code");
s11.text(18,260,"                                       timeout").addClass("code bold darkred");

s11.path("M327,90 l77,0").addClass("line").attr({"marker-end":marker,"stroke-width":"4px"});
s11.path("M697,178 l0,40").addClass("line").attr({"marker-end":marker,"stroke-width":"4px"});

</script>
</svg>
<div class="ulist"><ul><li><p><strong>Timeouts</strong> can be generated within the server</p></li><li><p><strong>Timeout</strong> is an integer in milliseconds or the atom <strong>infinity</strong></p></li><li><p>Default value is <strong>infinity</strong></p></li><li><p>Timeouts are triggered if no message is received within <strong>Timeout</strong> ms</p></li><li><p>Timeouts are reset after a <strong>timeout</strong> event or an incoming message</p></li></ul></div></section>
<section id="_other_issues_strong_sys_module_strong"><h2>Other Issues: <strong>sys module</strong></h2><div class="pre"><br />
<b>   sys:log(Server, Flag)      sys:log_to_file(Server,Flag)</b>

 Flag = true | {true,int()}     Flag = FileName | false
      | get | false | print

</div>
<div class="ulist"><ul><li><p><strong>sys:log/2</strong> turns on the logging of systems events</p><div class="ulist"><ul><li><p>A maximum of <strong>int()</strong> events are logged</p></li><li><p>Default value is 10</p></li></ul></div></li><li><p><strong>sys:log_to_file/2</strong> turns on the logging of system events to file</p></li></ul></div>
<aside class="notes"><div class="paragraph"><p>in start_link, the last argument is optional stuff. The sys module is what uses these and allows to turn it on and off.</p></div>
<div class="paragraph"><p>Allows debugging.</p></div></aside></section>
<section id="_other_issues_strong_sys_module_strong_2"><h2>Other Issues: <strong>sys module</strong></h2><div class="pre"><br />
<b> sys:statistics(Server, Flag)      sys:trace(Server,Flag)</b>

  Flag = true | false | get         Flag = true | false


</div>
<div class="ulist"><ul><li><p><strong>sys:statistics/2</strong> enables the logging of statistics</p><div class="ulist"><ul><li><p>Includes start/current times</p></li><li><p>Messages sent/received</p></li><li><p>The number of reductions</p></li></ul></div></li><li><p><strong>sys:trace/2</strong> prints all system events to standard IO</p><div class="ulist"><ul><li><p>You can implement your own debug/trigger function</p></li></ul></div></li></ul></div></section>
<section id="_other_issues_strong_sys_module_strong_3"><h2>Other Issues: <strong>sys module</strong></h2><div class="left">
<div class="pre">gen_server:start_link(
   {global, Name},
   Module,
   Args,
   <b>Options</b>
).


<b>Options:</b>
{debug, [trace|statistics|log
      | {log_to_file, FileName}
      | {install, {F, State}]}
| {timeout, Time}
| {spawn_opts, Opts}


</div></div>
<div class="ulist right"><ul><li><p>Options is a list of debug functions from the sys module</p></li><li><p>Can be set when starting the generic servers</p></li></ul></div></section>
<section id="_other_issues"><h2>Other Issues</h2><div class="pre" style="text-align:center; padding:14pt 0 16pt !important;">gen_server:start_link({global, Name}, Module, Args, Opts)

gen_server:start({local, Name}, Module, Args, Options)

gen_server:start(Modules, Args, Options) or
gen_server:start_link(Module, Args, Options)
</div>
<div class="ulist closer"><ul><li><p><strong>global</strong> registers the name globally in a network of nodes</p><div class="ulist"><ul><li><p><code><strong>gen_server:call({global, Name}, Msg)</strong></code> is used to make calls</p></li><li><p>The name must be unique among connected nodes</p></li><li><p>Location transparency is preserved</p></li></ul></div></li><li><p>Processes do not have to be linked to their supervisors</p></li><li><p>Processes do not have to be named</p><div class="ulist"><ul><li><p>referred to through their Pid</p></li></ul></div></li></ul></div>
<aside class="notes"><div class="paragraph"><p>Global names: Note that this now requires a different call with the {global, _} tuple</p></div>
<div class="paragraph"><p>Note that gen_server:start is only for debugging (in the shell, to avoid kills)
__</p></div></aside></section>
<section id="_generic_servers_4"><h2>Generic Servers</h2><div class="ulist"><ul><li><p>Generic Servers</p></li><li><p>Starting a Server</p></li><li><p>Message Passing</p></li><li><p>Termination</p></li><li><p>Other Messages</p></li><li><p>Timeouts</p></li><li><p>Other Issues</p></li></ul></div></section></div></div><script src="reveal.js/lib/js/head.min.js"></script><script src="reveal.js/js/reveal.min.js"></script><script type="text/javascript">// See https://github.com/hakimel/reveal.js#configuration for a full list of configuration options
Reveal.initialize({
  // Display controls in the bottom right corner
  controls: true,
  // Display a presentation progress bar
  progress: true,
  // Display the page number of the current slide
  slideNumber: true,
  // Push each slide change to the browser history
  history: true,
  // Enable keyboard shortcuts for navigation
  keyboard: true,
  // Enable the slide overview mode
  overview: true,
  // Vertical centering of slides
  center: false,
  // Enables touch navigation on devices with touch input
  touch: true,
  // Loop the presentation
  loop: false,
  // Change the presentation direction to be RTL
  rtl: false,
  // Turns fragments on and off globally
  fragments: true,
  // Flags if the presentation is running in an embedded mode,
  // i.e. contained within a limited portion of the screen
  embedded: false,
  // Number of milliseconds between automatically proceeding to the
  // next slide, disabled when set to 0, this value can be overwritten
  // by using a data-autoslide attribute on your slides
  autoSlide: 0,
  // Stop auto-sliding after user input
  autoSlideStoppable: true,
  // Enable slide navigation via mouse wheel
  mouseWheel: false,
  // Hides the address bar on mobile devices
  hideAddressBar: true,
  // Opens links in an iframe preview overlay
  previewLinks: false,
  // Theme (e.g., beige, blond, default, moon, night, serif, simple, sky, solarized)
  theme: Reveal.getQueryHash().theme || 'esl',
  // Transition style (e.g., default, cube, page, concave, zoom, linear, fade, none)
  transition: Reveal.getQueryHash().transition || 'linear',
  // Transition speed (e.g., default, fast, slow)
  transitionSpeed: 'default',
  // Transition style for full page slide backgrounds (e.g., default, none, slide, concave, convex, zoom)
  backgroundTransition: 'default',
  // Number of slides away from the current that are visible
  viewDistance: 3,
  // Parallax background image (e.g., "'https://s3.amazonaws.com/hakim-static/reveal-js/reveal-parallax-1.jpg'")
  parallaxBackgroundImage: '',
  // Parallax background size in CSS syntax (e.g., "2100px 900px")
  parallaxBackgroundSize: '',
  // Optional libraries used to extend on reveal.js
  dependencies: [
      { src: 'reveal.js/lib/js/classList.js', condition: function() { return !document.body.classList; } },
      { src: 'reveal.js/plugin/markdown/marked.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
      { src: 'reveal.js/plugin/markdown/markdown.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
      
      { src: 'reveal.js/plugin/zoom-js/zoom.js', async: true, condition: function() { return !!document.body.classList; } },
      { src: 'reveal.js/plugin/notes/notes.js', async: true, condition: function() { return !!document.body.classList; } }
  ]
});</script></body></html>